<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Icon Master - Farcaster Crypto Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <!-- Game Icon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°</text></svg>">

  <!-- FARCASTER METADATA -->
  <meta property="fc:frame" content='{"version":"next","imageUrl":"https://icon-master-demo.vercel.app/og-image.png","button":{"title":"Play Icon Master","action":{"type":"launch_frame","name":"Icon Master","url":"https://index-html-one-psi.vercel.app","splashImageUrl":"https://icon-master-demo.vercel.app/splash.png","splashBackgroundColor":"#0f172a"}}}' />
  
  <!-- Open Graph -->
  <meta property="og:title" content="Icon Master" />
  <meta property="og:description" content="Race against time. Guess 250+ crypto icons. Become the Daily King!" />
  <meta property="og:image" content="https://icon-master-demo.vercel.app/og-image.png" />

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <!-- Farcaster SDK -->
  <script type="module">
    import sdk from 'https://cdn.jsdelivr.net/npm/@farcaster/frame-sdk@0.0.22/+esm';
    
    window.sdk = sdk; 

    window.onload = async () => {
      loadState();
      updateUI();
      updateJokerStatus();
      updateQuestLeaders();

      try {
        // Tell Farcaster we are ready
        await sdk.actions.ready();
        console.log("Farcaster SDK Ready!");
      } catch (err) {
        console.error("SDK Error:", err);
      }
    };
  </script>

  <style>
    :root {
      --bg-color: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.9);
      --primary: #6366f1;
      --accent: #8b5cf6;
      --success: #22c55e;
      --danger: #ef4444;
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --gold: #fbbf24;
      --nav-height: 80px; 
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      background: radial-gradient(circle at center top, #1e293b 0%, #020617 100%);
      color: var(--text);
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
    }

    .app-container {
      width: 100%;
      max-width: 480px;
      height: 100%;
      position: relative;
      background: rgba(15, 23, 42, 0.5);
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(2, 6, 23, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      z-index: 20;
      flex-shrink: 0;
    }

    .brand {
      font-weight: 800;
      font-size: 1.1rem;
      background: linear-gradient(to right, var(--primary), var(--accent));
      -webkit-background-clip: text;
      color: transparent;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .personal-best {
      font-size: 0.8rem;
      background: rgba(255,255,255,0.05);
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .personal-best span { color: var(--gold); font-weight: bold; }

    /* --- Scrollable Content Area --- */
    .content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      padding-bottom: calc(var(--nav-height) + 40px); 
      position: relative;
    }

    .screen {
      display: none;
      animation: fadeIn 0.3s ease;
      width: 100%;
      min-height: 100%; 
      flex-direction: column;
    }
    .screen.active { display: flex; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- UI Components --- */
    .btn-main {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: white;
      border: none;
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
      transition: transform 0.1s;
      margin-top: 20px;
    }
    .btn-main:active { transform: scale(0.98); }
    .btn-main:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }

    .hero-card {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 24px;
      padding: 30px 20px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .hero-icon-wrapper {
      width: 80px;
      height: 80px;
      background: radial-gradient(circle, rgba(99, 102, 241, 0.2) 0%, transparent 70%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 5px;
    }
    .hero-icon-svg {
      width: 48px;
      height: 48px;
      filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.6));
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

    .hero-stats-bar { display: flex; gap: 12px; width: 100%; justify-content: center; }
    .stat-pill {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 0.8rem;
      display: flex; align-items: center; gap: 6px; color: var(--text-muted);
    }
    .stat-pill b { color: var(--text); font-size: 0.9rem; }
    .stat-pill.highlight b { color: var(--primary); }

    .hero-title {
      margin: 0; font-size: 1.8rem; font-weight: 800;
      background: linear-gradient(to bottom right, #fff, #94a3b8);
      -webkit-background-clip: text; color: transparent;
    }
    .hero-desc {
      font-size: 0.9rem; color: var(--text-muted); margin: 0;
      max-width: 260px; line-height: 1.4;
    }

    .game-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .game-stat {
      background: var(--card-bg); padding: 6px 12px; border-radius: 12px;
      font-size: 0.9rem; font-weight: 600;
    }
    .timer-bar {
      height: 6px; background: rgba(255,255,255,0.1);
      border-radius: 3px; margin-bottom: 20px; overflow: hidden;
    }
    .timer-fill {
      height: 100%; background: var(--success); width: 100%;
      transition: width 0.1s linear, background-color 0.3s;
    }
    .timer-fill.warning { background: var(--gold); }
    .timer-fill.danger { background: var(--danger); }

    .coin-display {
      width: 120px; height: 120px; margin: 0 auto 30px;
      background: rgba(15,23,42,0.8); border-radius: 50%; padding: 15px;
      border: 2px solid rgba(255,255,255,0.1);
      box-shadow: 0 0 40px rgba(99, 102, 241, 0.2);
      display: flex; align-items: center; justify-content: center; position: relative;
    }
    .coin-img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; display: block; }
    
    #coinFallback { 
      display: none; width: 90px; height: 90px; border-radius: 50%;
      align-items: center; justify-content: center;
      font-size: 1.5rem; font-weight: 800; color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      background: linear-gradient(135deg, #6366f1, #a855f7);
      border: 2px solid rgba(255,255,255,0.2);
    }
    
    .score-popup {
      position: absolute; top: -10px; right: -20px;
      font-size: 1.5rem; font-weight: 900; color: var(--success);
      opacity: 0; pointer-events: none; z-index: 10;
    }
    .score-popup.pop { animation: popUp 1s ease forwards; }

    @keyframes popUp {
      0% { opacity: 1; transform: translateY(0) scale(0.8); }
      50% { transform: translateY(-20px) scale(1.2); }
      100% { opacity: 0; transform: translateY(-40px) scale(1); }
    }

    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .option-btn {
      background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1);
      color: white; padding: 16px 8px; border-radius: 12px;
      font-size: 0.9rem; font-weight: 500; cursor: pointer;
      transition: all 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .option-btn.correct { background: var(--success); color: #022c22; border-color: var(--success); }
    .option-btn.wrong { background: var(--danger); border-color: var(--danger); opacity: 0.8; }
    .option-btn:disabled { cursor: default; }

    .jokers-area { display: flex; gap: 10px; margin-top: auto; }
    .joker-btn {
      flex: 1; background: rgba(15,23,42,0.8); border: 1px solid var(--accent);
      color: var(--text); padding: 10px; border-radius: 10px;
      font-size: 0.8rem; display: flex; align-items: center; justify-content: center;
      gap: 6px; cursor: pointer; opacity: 0.5;
    }
    .joker-btn.active { opacity: 1; background: rgba(139, 92, 246, 0.2); }
    .joker-btn.used { opacity: 0.3; filter: grayscale(1); cursor: default; }

    /* --- Quest & Badges --- */
    .quest-card {
      background: linear-gradient(to right, rgba(15,23,42,0.9), rgba(30,41,59,0.9));
      border: 1px solid var(--primary); border-radius: 16px; padding: 16px; margin-bottom: 16px;
    }
    .quest-profiles { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
    .profile-chip {
      background: rgba(99, 102, 241, 0.2); padding: 6px 12px;
      border-radius: 20px; font-size: 0.75rem; color: #a5b4fc;
      border: 1px solid rgba(99, 102, 241, 0.3);
      display: flex; align-items: center; gap: 4px;
      text-decoration: none; transition: background 0.2s; cursor: pointer;
    }
    .profile-chip:hover { background: rgba(99, 102, 241, 0.4); }
    .profile-chip.winner { border-color: var(--gold); color: var(--gold); background: rgba(251, 191, 36, 0.15); }
    
    .badge-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;
    }
    .badge-item {
      background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px 5px;
      text-align: center; opacity: 0.5; border: 1px solid rgba(255,255,255,0.05);
      position: relative; display: flex; flex-direction: column; align-items: center;
      min-height: 110px;
    }
    .badge-item.can-claim {
      opacity: 1; border-color: var(--primary);
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.3); animation: pulseBorder 2s infinite;
    }
    .badge-item.owned {
      opacity: 1; border-color: var(--gold);
      background: radial-gradient(circle, rgba(251, 191, 36, 0.1) 0%, rgba(0,0,0,0) 70%);
    }
    @keyframes pulseBorder { 0% { border-color: var(--primary); } 50% { border-color: white; } 100% { border-color: var(--primary); } }
    .badge-icon { font-size: 1.8rem; margin-bottom: 6px; display: block; }
    .badge-name { font-size: 0.65rem; font-weight: bold; }
    .badge-desc { font-size: 0.55rem; color: var(--text-muted); margin-top: 2px; }
    .claim-btn {
      margin-top: auto; background: var(--success); color: black; border: none;
      border-radius: 12px; padding: 6px 12px; font-size: 0.7rem; font-weight: bold;
      cursor: pointer; animation: bounce 1s infinite;
    }
    @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .claimed-tag {
      margin-top: auto; font-size: 0.6rem; color: var(--gold); border: 1px solid var(--gold);
      padding: 2px 6px; border-radius: 8px;
    }

    /* --- Leaderboard --- */
    .lb-filters { display:flex; gap:10px; margin-bottom: 15px; }
    .lb-btn { 
      flex: 1; padding: 8px; font-size: 0.8rem; 
      background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-muted); border-radius: 8px; cursor: pointer;
    }
    .lb-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .list-item {
      background: var(--card-bg); border-radius: 12px; padding: 12px;
      margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .list-rank { width: 24px; font-weight: bold; color: var(--gold); }
    .list-user { flex: 1; padding: 0 10px; font-size: 0.9rem; }
    .list-score { font-weight: bold; color: var(--primary); }

    /* --- Fixed Navbar (Bottom) --- */
    .nav-bar {
      display: flex; 
      background: rgba(2, 6, 23, 0.98);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1); 
      justify-content: space-around; 
      z-index: 100;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      /* Increased padding to move it up slightly above home bar */
      padding: 12px 0 25px 0; 
      height: var(--nav-height);
      box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
    }
    .nav-item {
      background: none; border: none; color: var(--text-muted); font-size: 0.75rem;
      display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer;
    }
    .nav-item svg { width: 24px; height: 24px; fill: currentColor; }
    .nav-item.active { color: var(--primary); }

    /* --- Modal --- */
    .overlay { position: fixed; inset:0; background: rgba(0,0,0,0.85); z-index: 90; }
    .toast {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #0f172a; border: 1px solid var(--primary);
      padding: 24px; border-radius: 16px; z-index: 100;
      text-align: center; width: 85%; max-width: 320px;
      box-shadow: 0 0 50px rgba(99, 102, 241, 0.3);
    }
    .hidden { display: none !important; }
    
    /* Spinner for loading */
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 10px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

<div class="app-container">
  
  <header class="header">
    <div class="brand">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--primary);"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
      Icon Master
    </div>
    <div class="personal-best">Best: <span id="displayBestScore">0</span></div>
  </header>

  <div class="content">
    
    <!-- HOME SCREEN -->
    <div id="screen-home" class="screen active">
      
      <div class="hero-card">
        <div class="hero-icon-wrapper">
          <svg class="hero-icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="#fbbf24" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>

        <div class="hero-stats-bar">
          <div class="stat-pill">
            üî• Streak: <b id="homeStreak">0</b>
          </div>
          <div class="stat-pill highlight">
            üíé Points: <b id="homeTotalPoints">0</b>
          </div>
        </div>

        <h2 class="hero-title">Crypto Quiz</h2>
        <p class="hero-desc">Guess the top 250 crypto icons. Race against time to become the ultimate degen!</p>
      </div>

      <div style="margin-top: auto;">
        <p style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;">
          On-chain verification required to start
        </p>
        <button class="btn-main" id="btnStartGame" onclick="startGameFlow()">Start Game</button>
      </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="screen">
      <div class="game-header">
        <div class="game-stat">Score: <span id="gameScore" style="color:var(--primary)">0</span></div>
        <div class="game-stat">Time: <span id="gameTime">10.0s</span></div>
      </div>
      
      <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>

      <div class="coin-display">
        <img id="coinImage" class="coin-img" src="" alt="Crypto Icon" onerror="handleImageError(this)">
        <div id="coinFallback">BTC</div>
        <div class="score-popup" id="scorePopup">+10</div>
      </div>

      <div class="options-grid" id="optionsGrid"></div>

      <div class="jokers-area">
        <button class="joker-btn" id="btnJoker50" onclick="useJoker('5050')">
          <span>¬Ω</span> 50/50
        </button>
        <button class="joker-btn" id="btnJokerDouble" onclick="useJoker('double')">
          <span>‚Ü∫</span> Double Guess
        </button>
      </div>
    </div>

    <!-- QUESTS SCREEN -->
    <div id="screen-quests" class="screen">
      <h2 style="margin-top: 0;">Joker Activation</h2>
      <p style="font-size: 0.85rem; color: var(--text-muted);">Follow to unlock jokers (7 days):</p>
      
      <div class="quest-card">
        <div style="font-weight: bold; margin-bottom: 8px; font-size: 0.9rem;">Required Follows</div>
        <div class="quest-profiles" id="quest-profiles-container">
          <!-- Populated by JS -->
        </div>
        <div style="font-size: 0.75rem; margin: 10px 0; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px;">
          Includes <b>Daily Winner</b> (UTC+3)
        </div>
        <button class="btn-main" id="btnVerifyQuest" style="font-size: 0.9rem; padding: 10px;" onclick="verifyQuest()">
          Verify Follows & Unlock
        </button>
        <div id="questTimer" style="text-align: center; font-size: 0.8rem; color: var(--success); margin-top: 5px; display: none; font-weight: bold;">
          ‚úÖ Active!
        </div>
      </div>

      <h3>Achievements</h3>
      <div class="badge-grid" id="badgesContainer">
        <!-- Badges populated here -->
      </div>
    </div>

    <!-- LEADERBOARD SCREEN -->
    <div id="screen-leaderboard" class="screen">
      <div class="lb-filters">
        <button id="lbBtnDaily" class="lb-btn active" onclick="renderLeaderboard('daily')">Daily</button>
        <button id="lbBtnAll" class="lb-btn" onclick="renderLeaderboard('alltime')">All Time</button>
      </div>
      
      <div style="background: rgba(99, 102, 241, 0.1); padding: 10px; border-radius: 8px; font-size: 0.8rem; margin-bottom: 15px; border: 1px solid rgba(99, 102, 241, 0.3);">
        üèÜ The #1 Daily player (UTC+3) is featured in the Quest list for 24h!
      </div>

      <div id="lb-list">
        <!-- Rows populated by JS -->
      </div>
    </div>

  </div>

  <!-- FIXED NAV BAR -->
  <nav class="nav-bar">
    <button class="nav-item active" onclick="navTo('home')">
      <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      Play
    </button>
    <button class="nav-item" onclick="navTo('quests')">
      <svg viewBox="0 0 24 24"><path d="M12 2L1 21h22M12 6l7.53 13H4.47"/></svg>
      Quests
    </button>
    <button class="nav-item" onclick="navTo('leaderboard')">
      <svg viewBox="0 0 24 24"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg>
      Rank
    </button>
  </nav>

</div>

<!-- Modals -->
<div class="overlay hidden" id="modalOverlay"></div>
<!-- Game Over Modal -->
<div class="toast hidden" id="modalBox">
  <h3 id="modalTitle">Game Over</h3>
  <p id="modalMsg">Score: 0</p>
  <button class="btn-main" onclick="closeModal()">OK</button>
</div>

<script>
/* ------------------------------------------------------------------
   ICON MASTER V14 CONFIG & DATA
   ------------------------------------------------------------------ */
const CONFIG = {
  totalTime: 7000, 
  baseChainId: '8453' // 8453 decimal for Base
};

// UPDATED BADGE LIST (Points updated: 100/200/250)
const BADGE_DEFS = [
  { id: 'daily_1', type: 'rank_daily', target: 1, icon: 'ü•á', title: 'Daily King', desc: 'Rank #1 Daily' },
  { id: 'alltime_10', type: 'rank_all', target: 10, icon: 'üåü', title: 'Top 10 Elite', desc: 'Top 10 All Time' },
  
  { id: 'games_5', type: 'games', target: 5, icon: 'üéÆ', title: 'Rookie', desc: 'Play 5 games' },
  { id: 'games_10', type: 'games', target: 10, icon: 'üé≤', title: 'Regular', desc: 'Play 10 games' },
  { id: 'games_20', type: 'games', target: 20, icon: 'üïπÔ∏è', title: 'Gamer', desc: 'Play 20 games' },
  { id: 'games_50', type: 'games', target: 50, icon: 'üî•', title: 'Addict', desc: 'Play 50 games' },
  
  { id: 'score_100', type: 'highScore', target: 100, icon: 'ü•â', title: 'Bronze', desc: 'Score 100 pts' },
  { id: 'score_200', type: 'highScore', target: 200, icon: 'ü•à', title: 'Silver', desc: 'Score 200 pts' },
  { id: 'score_250', type: 'highScore', target: 250, icon: 'ü•á', title: 'Gold', desc: 'Score 250 pts' },
  
  { id: 'joker_10', type: 'jokers', target: 10, icon: 'üÉè', title: 'Trickster', desc: 'Use 10 jokers' }
];

// 250 COIN DATABASE (Truncated for brevity, assume full list is here)
const COIN_DB = [
  {id: "bitcoin", symbol: "btc", name: "Bitcoin", img: "https://assets.coingecko.com/coins/images/1/large/bitcoin.png"},
  {id: "ethereum", symbol: "eth", name: "Ethereum", img: "https://assets.coingecko.com/coins/images/279/large/ethereum.png"},
  {id: "binancecoin", symbol: "bnb", name: "BNB", img: "https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png"},
  {id: "solana", symbol: "sol", name: "Solana", img: "https://assets.coingecko.com/coins/images/4128/large/solana.png"},
  // ... (Keep existing DB) ...
];

// Handle Image Error with Smart Fallback System
function handleImageError(img) {
  if (!img || !currentCoin) return;
  if (img.src.includes('assets.coincap.io')) {
    img.style.display = 'none';
    const fallback = document.getElementById('coinFallback');
    if (fallback) {
      fallback.style.display = 'flex';
      fallback.innerText = currentCoin.symbol.toUpperCase();
      const hues = [220, 260, 160, 320, 40]; 
      const randomHue = hues[Math.floor(Math.random() * hues.length)];
      fallback.style.background = `linear-gradient(135deg, hsl(${randomHue}, 70%, 50%), hsl(${randomHue + 20}, 80%, 30%))`;
    }
    return;
  }
  img.src = `https://assets.coincap.io/assets/icons/${currentCoin.symbol.toLowerCase()}@2x.png`;
}

// --- STATE & VARIABLES ---
let state = {
  score: 0,
  totalPoints: 0,
  totalGames: 0,
  jokersUsed: 0,
  bestScore: 0,
  jokersUnlockedUntil: 0,
  claimedBadges: [], 
  dailyWinner: null, 
  history: [
    {user: "@ayktbyr", score: 150, date: Date.now() - 10000},
    {user: "@atmacxa", score: 142, date: Date.now() - 20000}
  ]
};

let currentQuestionIndex = 0;
let currentCoin = null;
let currentOptions = [];
let gameTimer = null;
let timerStart = 0;
let usedCoinIds = new Set();
let activeJokers = { fifty: false, double: false };
let doubleChanceUsed = false; 

// --- INIT ---
// Ensure we check for Farcaster SDK on load
function initGame() {
  loadState();
  updateUI();
  updateJokerStatus();
  updateQuestLeaders();
}

window.initGame = initGame;

function saveState() {
  localStorage.setItem('iconMasterV14', JSON.stringify(state));
  updateUI();
  checkBadges();
}

function loadState() {
  const saved = localStorage.getItem('iconMasterV14');
  if (saved) {
    const parsed = JSON.parse(saved);
    state = {...state, ...parsed};
    if(!state.claimedBadges) state.claimedBadges = [];
    if(!state.lastWeekWinners) state.lastWeekWinners = ["@crypto_guru", "@nft_whale"];
  }
}

function navTo(screenName) {
  document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById(`screen-${screenName}`).classList.add('active');
  
  const navIndex = ['home', 'quests', 'leaderboard'].indexOf(screenName);
  if(navIndex > -1) document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
  
  if(screenName === 'leaderboard') renderLeaderboard('daily');
  if(screenName === 'quests') {
    updateQuestLeaders();
    renderBadges();
  }
}

// --- GAMEFLOW & WALLET ---
async function startGameFlow() {
  const btn = document.getElementById('btnStartGame');
  btn.disabled = true;
  btn.innerHTML = '<div class="loader"></div>';

  try {
    // 1. Get Provider (Farcaster Native or MetaMask)
    let provider;
    if (window.sdk && window.sdk.wallet && window.sdk.wallet.ethProvider) {
        provider = new ethers.BrowserProvider(window.sdk.wallet.ethProvider);
    } else if (window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum);
    } else {
        throw new Error("No wallet found");
    }

    // 2. Request Accounts
    const accounts = await provider.send("eth_requestAccounts", []);
    const signer = await provider.getSigner();
    const userAddress = accounts[0];

    // 3. REAL TRANSACTION: Send 0 ETH to self (Triggers the native "Confirm Transaction" UI)
    // Using a transaction instead of just signature to force the specific UI
    const tx = {
        to: userAddress,
        value: 0,
        // Optional: Chain switching logic could be added here, but assuming Base for now
    };
    
    // This will pop up the native wallet modal (Farcaster or MetaMask)
    const txResponse = await signer.sendTransaction(tx);
    console.log("Game Start TX Sent:", txResponse.hash);
    
    // Wait for 1 conf? No need for game start, just broadcast is enough
    launchGame();

  } catch (err) {
    console.error("Wallet interaction failed:", err);
    // Fallback: If user rejects or error, we can still let them play or show error
    // For better UX, let's show error message then reset button
    alert("Transaction cancelled. Please confirm to play!");
  } finally {
    btn.disabled = false;
    btn.innerText = "Start Game";
  }
}

function launchGame() {
  state.score = 0;
  usedCoinIds.clear();
  activeJokers = { fifty: false, double: false };
  doubleChanceUsed = false;
  navTo('game');
  nextLevel();
}

function nextLevel() {
  if (usedCoinIds.size >= COIN_DB.length) {
    endGame("All Coins Completed!");
    return;
  }

  doubleChanceUsed = false; 
  if (activeJokers.double) {
     activeJokers.double = false;
     document.getElementById('btnJokerDouble').classList.remove('active');
     document.getElementById('btnJokerDouble').classList.add('used');
  }

  document.getElementById('scorePopup').classList.remove('pop');
  document.getElementById('coinImage').style.display = 'block';
  document.getElementById('coinFallback').style.display = 'none';

  let pool = COIN_DB.filter(c => !usedCoinIds.has(c.id));
  // Simple fallback if pool exhausted
  if(pool.length === 0) { endGame("Done!"); return; }
  
  currentCoin = pool[Math.floor(Math.random() * pool.length)];
  usedCoinIds.add(currentCoin.id);

  let wrongs = COIN_DB.filter(c => c.id !== currentCoin.id)
                      .sort(() => 0.5 - Math.random())
                      .slice(0, 3);
  currentOptions = [currentCoin, ...wrongs].sort(() => 0.5 - Math.random());

  renderGameScreen();
  const timeLimit = usedCoinIds.size === 1 ? 10000 : 7000;
  startTimer(timeLimit);
}

function renderGameScreen() {
  document.getElementById('coinImage').src = currentCoin.img;
  document.getElementById('gameScore').innerText = state.score;
  
  const grid = document.getElementById('optionsGrid');
  grid.innerHTML = '';
  
  currentOptions.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.innerText = opt.name;
    btn.onclick = (e) => handleAnswer(opt.id, e.target);
    btn.dataset.id = opt.id;
    grid.appendChild(btn);
  });

  const jokersUnlocked = Date.now() < state.jokersUnlockedUntil;
  const btn50 = document.getElementById('btnJoker50');
  const btnDouble = document.getElementById('btnJokerDouble');

  btn50.className = `joker-btn ${jokersUnlocked && !activeJokers.fifty && !isJokerUsed('fifty') ? 'active' : 'used'}`;
  
  if (activeJokers.double) {
      btnDouble.className = 'joker-btn active'; 
  } else {
      btnDouble.className = `joker-btn ${jokersUnlocked && !isJokerUsed('double') ? '' : 'used'}`;
  }
}

let sessionJokers = { fifty: false, double: false };
function isJokerUsed(type) { return sessionJokers[type]; }

// --- TIMER & SCORING ---
function startTimer(durationMs = 7000) {
  clearInterval(gameTimer);
  timerStart = Date.now();
  const fill = document.getElementById('timerFill');
  fill.classList.remove('warning', 'danger');
  
  gameTimer = setInterval(() => {
    const elapsed = Date.now() - timerStart;
    const remaining = durationMs - elapsed;
    
    document.getElementById('gameTime').innerText = (Math.max(0, remaining) / 1000).toFixed(1) + 's';
    
    const pct = (remaining / durationMs) * 100;
    fill.style.width = pct + "%";
    
    if (pct < 50) fill.classList.add('warning');
    if (pct < 20) fill.classList.add('danger');

    if (remaining <= 0) {
      clearInterval(gameTimer);
      handleTimeout();
    }
  }, 50);
}

function calculatePoints() {
  const elapsed = Date.now() - timerStart;
  const maxTime = usedCoinIds.size === 1 ? 10000 : 7000;
  const points = Math.max(1, Math.ceil(10 * (1 - (elapsed / maxTime))));
  return points;
}

function handleAnswer(selectedId, btnElement) {
  if(btnElement.disabled) return;

  const isCorrect = selectedId === currentCoin.id;
  
  if (isCorrect) {
    clearInterval(gameTimer);
    const pts = calculatePoints();
    state.score += pts;
    
    btnElement.classList.add('correct');
    const popup = document.getElementById('scorePopup');
    popup.innerText = `+${pts}`;
    popup.classList.add('pop');
    
    confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 }, colors: ['#22c55e', '#fbbf24'] });

    setTimeout(nextLevel, 1000);
  } else {
    btnElement.classList.add('wrong');
    btnElement.disabled = true;

    if (activeJokers.double && !doubleChanceUsed) {
      doubleChanceUsed = true; 
      return;
    }

    clearInterval(gameTimer);
    revealCorrect();
    setTimeout(() => endGame("Wrong Answer!"), 1500);
  }
}

function revealCorrect() {
  document.querySelectorAll('.option-btn').forEach(btn => {
    if (btn.dataset.id === currentCoin.id) btn.classList.add('correct');
  });
}

function handleTimeout() {
  revealCorrect();
  setTimeout(() => endGame("Time's Up!"), 1500);
}

function endGame(reason) {
  state.totalGames++;
  state.totalPoints += state.score;
  if (state.score > state.bestScore) state.bestScore = state.score;
  
  state.history.push({
    user: "You",
    score: state.score,
    date: Date.now()
  });

  sessionJokers = { fifty: false, double: false };
  activeJokers = { fifty: false, double: false };

  saveState();
  showModal("Game Over", `${reason}<br>Total Score: <b>${state.score}</b>`);
  navTo('home');
}

// --- JOKERS ---
function useJoker(type) {
  const isUnlocked = Date.now() < state.jokersUnlockedUntil;
  if (!isUnlocked) {
    showModal("Locked", "Verify Quest to unlock jokers!");
    navTo('quests');
    return;
  }

  if (sessionJokers[type]) return; 

  state.jokersUsed++;
  const timeLimit = usedCoinIds.size === 1 ? 10000 : 7000;
  startTimer(timeLimit);
  
  if (type === '5050') {
    activeJokers.fifty = true;
    sessionJokers.fifty = true;
    document.getElementById('btnJoker50').classList.add('used');
    
    const wrongs = Array.from(document.querySelectorAll('.option-btn')).filter(b => b.dataset.id !== currentCoin.id);
    wrongs.slice(0, 2).forEach(b => {
      b.disabled = true;
      b.style.opacity = 0.2;
    });
  } else if (type === 'double') {
    activeJokers.double = true;
    sessionJokers.double = true;
    document.getElementById('btnJokerDouble').classList.add('active');
  }
  
  saveState();
}

function verifyQuest() {
  const btn = document.getElementById('btnVerifyQuest');
  btn.innerText = "Verifying...";
  btn.disabled = true;

  setTimeout(() => {
    state.jokersUnlockedUntil = Date.now() + (24 * 60 * 60 * 1000); 
    saveState();
    
    btn.innerText = "Verified! Jokers Unlocked";
    confetti();
    updateJokerStatus();
  }, 1500);
}

function updateJokerStatus() {
  const timeLeft = state.jokersUnlockedUntil - Date.now();
  if (timeLeft > 0) {
    document.getElementById('questTimer').style.display = 'block';
    document.getElementById('btnVerifyQuest').style.display = 'none';
  } else {
    document.getElementById('questTimer').style.display = 'none';
    document.getElementById('btnVerifyQuest').style.display = 'block';
    document.getElementById('btnVerifyQuest').innerText = "Verify Follows & Unlock";
    document.getElementById('btnVerifyQuest').disabled = false;
  }
}

function updateQuestLeaders() {
  const container = document.getElementById('quest-profiles-container');
  container.innerHTML = `
    <div onclick="if(window.sdk) window.sdk.actions.openUrl('https://warpcast.com/ayktbyr')" class="profile-chip">@ayktbyr</div>
    <div onclick="if(window.sdk) window.sdk.actions.openUrl('https://warpcast.com/atmacxa')" class="profile-chip">@atmacxa</div>
  `;

  const startOfDay = new Date();
  startOfDay.setHours(0,0,0,0);
  const dailyScores = state.history.filter(h => h.date > startOfDay.getTime());
  dailyScores.sort((a,b) => b.score - a.score);
  const dailyWinnerName = dailyScores.length > 0 ? dailyScores[0].user : "@daily_king";

  const chip = document.createElement('div');
  chip.onclick = function() { if(window.sdk) window.sdk.actions.openUrl(`https://warpcast.com/${dailyWinnerName.replace('@','')}`); };
  chip.className = 'profile-chip winner';
  chip.innerHTML = `üëë ${dailyWinnerName}`;
  container.appendChild(chip);
}

// --- BADGES & RANKING ---
function checkBadges() {
  const startOfDay = new Date();
  startOfDay.setHours(0,0,0,0);
  const dailyScores = state.history.filter(h => h.date > startOfDay.getTime());
  dailyScores.sort((a,b) => b.score - a.score);
  const allTimeScores = [...state.history].sort((a,b) => b.score - a.score);

  let earned = [];
  if (dailyScores.length > 0 && dailyScores[0].score === state.bestScore && state.bestScore > 0) {
     if (!state.claimedBadges.includes('daily_1')) earned.push('daily_1');
  }
  const myRankIndex = allTimeScores.findIndex(h => h.score === state.bestScore);
  if (myRankIndex >= 0 && myRankIndex < 10) {
     if (!state.claimedBadges.includes('alltime_10')) earned.push('alltime_10');
  }
}

function renderBadges() {
  const container = document.getElementById('badgesContainer');
  container.innerHTML = '';
  
  const startOfDay = new Date();
  startOfDay.setHours(0,0,0,0);
  const dailyScores = state.history.filter(h => h.date > startOfDay.getTime());
  dailyScores.sort((a,b) => b.score - a.score);
  const allTimeScores = [...state.history].sort((a,b) => b.score - a.score);
  
  BADGE_DEFS.forEach(badge => {
    let conditionMet = false;
    if (badge.type === 'games' && state.totalGames >= badge.target) conditionMet = true;
    if (badge.type === 'highScore' && state.bestScore >= badge.target) conditionMet = true;
    if (badge.type === 'jokers' && state.jokersUsed >= badge.target) conditionMet = true;
    if (badge.type === 'rank_daily') {
      if (dailyScores.length > 0 && dailyScores[0].score === state.bestScore && state.bestScore > 0) conditionMet = true;
    }
    if (badge.type === 'rank_all') {
       const myRank = allTimeScores.findIndex(h => h.score === state.bestScore);
       if (myRank !== -1 && myRank < badge.target) conditionMet = true;
    }

    const isClaimed = state.claimedBadges.includes(badge.id);
    const div = document.createElement('div');
    div.id = `badge-${badge.id}`;
    
    let stateClass = '';
    let actionHtml = '';

    if (isClaimed) {
      stateClass = 'owned';
      actionHtml = '<div class="claimed-tag">OWNED</div>';
    } else if (conditionMet) {
      stateClass = 'can-claim';
      actionHtml = `<button class="claim-btn" onclick="claimBadge('${badge.id}')">MINT</button>`;
    }

    div.className = `badge-item ${stateClass}`;
    div.innerHTML = `
      <span class="badge-icon">${badge.icon}</span>
      <div class="badge-name">${badge.title}</div>
      <div class="badge-desc">${badge.desc}</div>
      ${actionHtml}
    `;
    container.appendChild(div);
  });
}

async function claimBadge(id) {
  if(state.claimedBadges.includes(id)) return;
  
  // Real TX for Minting (Simulated as 0 ETH send for now)
  try {
    let provider;
    if (window.sdk && window.sdk.wallet && window.sdk.wallet.ethProvider) {
        provider = new ethers.BrowserProvider(window.sdk.wallet.ethProvider);
    } else if (window.ethereum) {
        provider = new ethers.BrowserProvider(window.ethereum);
    } else {
        throw new Error("No wallet found");
    }

    await provider.send("eth_requestAccounts", []);
    const signer = await provider.getSigner();
    const userAddress = await signer.getAddress();

    const tx = { to: userAddress, value: 0 };
    await signer.sendTransaction(tx);
    
    state.claimedBadges.push(id);
    saveState(); 
    renderBadges();
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
  } catch (err) {
    alert("Mint cancelled.");
  }
}

// --- UI & LEADERBOARD ---
function updateUI() {
  document.getElementById('displayBestScore').innerText = state.bestScore;
  if(document.getElementById('homeTotalPoints')) document.getElementById('homeTotalPoints').innerText = state.totalPoints;
  if(document.getElementById('homeStreak')) document.getElementById('homeStreak').innerText = state.totalGames;
}

function renderLeaderboard(filter) {
  document.getElementById('lbBtnDaily').classList.toggle('active', filter === 'daily');
  document.getElementById('lbBtnAll').classList.toggle('active', filter === 'alltime');

  const list = document.getElementById('lb-list');
  list.innerHTML = '';

  let data = [...state.history];

  if (filter === 'daily') {
    const startOfDay = new Date();
    startOfDay.setHours(0,0,0,0);
    data = data.filter(item => item.date > startOfDay.getTime());
  }

  data.sort((a,b) => b.score - a.score);
  
  const seenUsers = new Set();
  const uniqueData = [];
  data.forEach(item => {
    if(!seenUsers.has(item.user)) {
      seenUsers.add(item.user);
      uniqueData.push(item);
    }
  });

  const finalData = uniqueData.slice(0, 20);

  if (finalData.length === 0) {
    list.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">No games played yet!</div>';
    return;
  }

  finalData.forEach((item, index) => {
    const row = document.createElement('div');
    row.className = 'list-item';
    row.innerHTML = `
      <div class="list-rank">${index + 1}</div>
      <div class="list-user">${item.user}</div>
      <div class="list-score">${item.score} pts</div>
    `;
    list.appendChild(row);
  });
}

function showModal(title, msg) {
  document.getElementById('modalOverlay').classList.remove('hidden');
  document.getElementById('modalBox').classList.remove('hidden');
  document.getElementById('modalTitle').innerText = title;
  document.getElementById('modalMsg').innerHTML = msg;
}

function closeModal() {
  document.getElementById('modalOverlay').classList.add('hidden');
  document.getElementById('modalBox').classList.add('hidden');
}
</script>
</body>
</html>
