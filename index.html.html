<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Icon Master - Farcaster Crypto Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <link rel="icon" href="https://icon-master-demo.vercel.app/splash.png">

  <!-- FARCASTER METADATA -->
  <meta property="fc:frame" content='{"version":"next","imageUrl":"https://icon-master-demo.vercel.app/og-image.png","button":{"title":"Play Icon Master","action":{"type":"launch_frame","name":"Icon Master","url":"https://index-html-one-psi.vercel.app","splashImageUrl":"https://icon-master-demo.vercel.app/splash.png","splashBackgroundColor":"#0f172a"}}}' />
  
  <meta property="og:title" content="Icon Master" />
  <meta property="og:description" content="Race against time. Guess 250+ crypto icons. Become the Daily King!" />
  <meta property="og:image" content="https://icon-master-demo.vercel.app/og-image.png" />

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  
  <!-- Farcaster SDK -->
  <script type="module">
    import sdk from 'https://cdn.jsdelivr.net/npm/@farcaster/frame-sdk@0.0.22/+esm';
    window.sdk = sdk; 
    window.onload = async () => {
      loadState();
      updateUI();
      updateJokerStatus();
      updateQuestLeaders();
      try { await sdk.actions.ready(); } catch (e) {}
    };
  </script>

  <style>
    :root {
      --bg-color: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.9);
      --primary: #6366f1;
      --accent: #8b5cf6;
      --success: #22c55e;
      --danger: #ef4444;
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --gold: #fbbf24;
      --nav-height: 80px; 
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      background: radial-gradient(circle at center top, #1e293b 0%, #020617 100%);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .app-container {
      width: 100%;
      max-width: 480px;
      height: 100%;
      margin: 0 auto;
      position: relative;
      background: rgba(15, 23, 42, 0.5);
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(2, 6, 23, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      z-index: 20;
      flex-shrink: 0;
    }

    .brand {
      font-weight: 800;
      font-size: 1.1rem;
      background: linear-gradient(to right, var(--primary), var(--accent));
      -webkit-background-clip: text;
      color: transparent;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .personal-best {
      font-size: 0.8rem;
      background: rgba(255,255,255,0.05);
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .personal-best span { color: var(--gold); font-weight: bold; }

    /* --- Content Area --- */
    .content {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 16px;
      padding-bottom: calc(var(--nav-height) + 40px); 
      position: relative;
      z-index: 10;
    }

    .screen {
      display: none;
      animation: fadeIn 0.3s ease;
      width: 100%;
      flex-direction: column;
    }
    .screen.active { display: flex; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .btn-main {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: white; border: none; width: 100%; padding: 16px; border-radius: 16px;
      font-size: 1.1rem; font-weight: 700; cursor: pointer;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4); transition: transform 0.1s;
      margin-top: 20px; display: flex; justify-content: center; align-items: center;
    }
    .btn-main:active { transform: scale(0.98); }
    .btn-main:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
    
    .btn-secondary {
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      color: var(--text); width: 100%; padding: 12px; border-radius: 16px;
      font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;
    }

    .hero-card {
      background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 30px 20px;
      text-align: center; margin-bottom: 20px;
      box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6);
      display: flex; flex-direction: column; align-items: center; gap: 16px;
    }

    .hero-icon-wrapper {
      width: 80px; height: 80px;
      background: radial-gradient(circle, rgba(99, 102, 241, 0.2) 0%, transparent 70%);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      margin-bottom: 5px;
    }
    .hero-icon-svg { width: 48px; height: 48px; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.6)); }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

    .hero-stats-bar { display: flex; gap: 12px; width: 100%; justify-content: center; }
    .stat-pill {
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      padding: 6px 12px; border-radius: 12px; font-size: 0.8rem;
      display: flex; align-items: center; gap: 6px; color: var(--text-muted);
    }
    .stat-pill b { color: var(--text); font-size: 0.9rem; }
    .stat-pill.highlight b { color: var(--primary); }

    .hero-title {
      margin: 0; font-size: 1.8rem; font-weight: 800;
      background: linear-gradient(to bottom right, #fff, #94a3b8);
      -webkit-background-clip: text; color: transparent;
    }
    .hero-desc { font-size: 0.9rem; color: var(--text-muted); margin: 0; max-width: 260px; line-height: 1.4; }

    .game-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .game-stat { background: var(--card-bg); padding: 6px 12px; border-radius: 12px; font-size: 0.9rem; font-weight: 600; }
    .timer-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
    .timer-fill { height: 100%; background: var(--success); width: 100%; transition: width 0.1s linear, background-color 0.3s; }
    .timer-fill.warning { background: var(--gold); } .timer-fill.danger { background: var(--danger); }

    .coin-display {
      width: 120px; height: 120px; margin: 0 auto 30px;
      background: rgba(15,23,42,0.8); border-radius: 50%; padding: 15px;
      border: 2px solid rgba(255,255,255,0.1);
      box-shadow: 0 0 40px rgba(99, 102, 241, 0.2);
      display: flex; align-items: center; justify-content: center; position: relative;
    }
    .coin-img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; display: block; }
    #coinFallback { 
      display: none; width: 90px; height: 90px; border-radius: 50%;
      align-items: center; justify-content: center;
      font-size: 1.5rem; font-weight: 800; color: white;
      background: linear-gradient(135deg, #6366f1, #a855f7);
      border: 2px solid rgba(255,255,255,0.2);
    }
    
    .score-popup {
      position: absolute; top: -10px; right: -20px;
      font-size: 1.5rem; font-weight: 900; color: var(--success);
      opacity: 0; pointer-events: none; z-index: 10;
    }
    .score-popup.pop { animation: popUp 1s ease forwards; }
    
    .game-over-text {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 1.2rem; font-weight: 900; color: var(--danger);
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        text-align: center;
        display: none; z-index: 15;
        background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 8px;
        pointer-events: none;
    }

    @keyframes popUp { 0% { opacity: 1; transform: translateY(0) scale(0.8); } 50% { transform: translateY(-20px) scale(1.2); } 100% { opacity: 0; transform: translateY(-40px) scale(1); } }

    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .option-btn {
      background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1);
      color: white; padding: 16px 8px; border-radius: 12px;
      font-size: 0.9rem; font-weight: 500; cursor: pointer;
      transition: all 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .option-btn.correct { background: var(--success); color: #022c22; border-color: var(--success); }
    .option-btn.wrong { background: var(--danger); border-color: var(--danger); opacity: 0.8; }
    .option-btn:disabled { opacity: 0.7; cursor: default; }

    .jokers-area { display: flex; gap: 10px; margin-top: auto; }
    .joker-btn {
      flex: 1; background: rgba(15,23,42,0.8); border: 1px solid var(--accent);
      color: var(--text); padding: 10px; border-radius: 10px;
      font-size: 0.8rem; display: flex; align-items: center; justify-content: center;
      gap: 6px; cursor: pointer; opacity: 0.5;
    }
    .joker-btn.active { opacity: 1; background: rgba(139, 92, 246, 0.2); }
    .joker-btn.used { opacity: 0.3; filter: grayscale(1); cursor: default; }

    /* --- Leaderboard Filters --- */
    .lb-filters { 
        display:flex; gap:10px; margin-bottom: 15px; 
        position: relative; z-index: 30; 
    }
    .lb-btn { 
      flex: 1; padding: 12px; font-size: 0.85rem; 
      background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1);
      color: var(--text-muted); border-radius: 8px; cursor: pointer;
      transition: all 0.2s ease;
    }
    .lb-btn:active { transform: scale(0.95); }
    .lb-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }
    .list-item {
      background: var(--card-bg); border-radius: 12px; padding: 12px;
      margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .list-rank { width: 24px; font-weight: bold; color: var(--gold); }
    .list-user { flex: 1; padding: 0 10px; font-size: 0.9rem; }
    .list-score { font-weight: bold; color: var(--primary); }

    /* --- Quest & Badges --- */
    .quest-card { background: linear-gradient(to right, rgba(15,23,42,0.9), rgba(30,41,59,0.9)); border: 1px solid var(--primary); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
    .quest-profiles { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
    .profile-chip {
      background: rgba(99, 102, 241, 0.2); padding: 6px 12px;
      border-radius: 20px; font-size: 0.75rem; color: #a5b4fc;
      border: 1px solid rgba(99, 102, 241, 0.3);
      display: flex; align-items: center; gap: 4px;
      text-decoration: none; transition: background 0.2s; cursor: pointer;
    }
    .profile-chip:hover { background: rgba(99, 102, 241, 0.4); }
    .profile-chip.winner { border-color: var(--gold); color: var(--gold); background: rgba(251, 191, 36, 0.15); }
    
    .badge-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .badge-item {
      background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px 5px;
      text-align: center; opacity: 0.5; border: 1px solid rgba(255,255,255,0.05);
      position: relative; display: flex; flex-direction: column; align-items: center;
      min-height: 110px;
    }
    .badge-item.can-claim { opacity: 1; border-color: var(--primary); box-shadow: 0 0 10px rgba(99, 102, 241, 0.3); animation: pulseBorder 2s infinite; }
    .badge-item.owned { opacity: 1; border-color: var(--gold); background: radial-gradient(circle, rgba(251, 191, 36, 0.1) 0%, rgba(0,0,0,0) 70%); }
    @keyframes pulseBorder { 0% { border-color: var(--primary); } 50% { border-color: white; } 100% { border-color: var(--primary); } }
    .badge-icon { font-size: 1.8rem; margin-bottom: 6px; display: block; }
    .badge-name { font-size: 0.65rem; font-weight: bold; }
    .badge-desc { font-size: 0.55rem; color: var(--text-muted); margin-top: 2px; }

    /* --- Fixed Navbar --- */
    .nav-bar {
      display: flex; background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1); justify-content: space-around; 
      z-index: 999; position: fixed; bottom: 0; left: 0; width: 100%;
      padding-bottom: env(safe-area-inset-bottom, 20px); height: auto; min-height: var(--nav-height);
      box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
    }
    .nav-item {
      background: none; border: none; color: var(--text-muted); font-size: 0.75rem;
      display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; padding: 10px;
    }
    .nav-item svg { width: 24px; height: 24px; fill: currentColor; } .nav-item.active { color: var(--primary); }

    /* --- Modal --- */
    .overlay { position: fixed; inset:0; background: rgba(0,0,0,0.85); z-index: 2000; }
    
    .result-modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #0f172a; border: 1px solid var(--primary);
      padding: 30px; border-radius: 24px; z-index: 2001;
      text-align: center; width: 85%; max-width: 350px;
      box-shadow: 0 0 50px rgba(99, 102, 241, 0.5);
      display: flex; flex-direction: column; align-items: center;
      animation: scaleUp 0.3s ease-out;
    }
    @keyframes scaleUp { from { transform: translate(-50%, -40%) scale(0.9); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

    .res-title { font-size: 1.8rem; font-weight: 800; color: var(--danger); margin-bottom: 10px; }
    .res-score { font-size: 3rem; font-weight: 900; color: white; margin: 10px 0; text-shadow: 0 0 20px var(--primary); }
    .res-label { color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
    .res-best { margin-top: 5px; font-size: 0.9rem; color: var(--gold); background: rgba(251, 191, 36, 0.1); padding: 4px 12px; border-radius: 12px; }
    
    .hidden { display: none !important; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="app-container">
  <header class="header">
    <div class="brand">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--primary);"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg> Icon Master
    </div>
    <div class="personal-best">Best: <span id="displayBestScore">0</span></div>
  </header>

  <div class="content">
    <!-- HOME -->
    <div id="screen-home" class="screen active">
      <div class="hero-card">
        <div class="hero-icon-wrapper">
          <svg class="hero-icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="#fbbf24" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="hero-stats-bar">
          <div class="stat-pill">üî• Streak: <b id="homeStreak">0</b></div>
          <div class="stat-pill highlight">üíé Points: <b id="homeTotalPoints">0</b></div>
        </div>
        <h2 class="hero-title">Crypto Quiz</h2>
        <p class="hero-desc">Guess the top 250 crypto icons. Race against time!</p>
      </div>
      <div style="margin-top: auto;">
        <p style="text-align: center; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;">
          On-chain verification required to start
        </p>
        <button class="btn-main" id="btnStartGame" onclick="startGameFlow()">Start Game</button>
      </div>
    </div>

    <!-- GAME -->
    <div id="screen-game" class="screen">
      <div class="game-header">
        <div class="game-stat">Score: <span id="gameScore" style="color:var(--primary)">0</span></div>
        <div class="game-stat">Time: <span id="gameTime">10.0s</span></div>
      </div>
      <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
      <div class="coin-display">
        <img id="coinImage" class="coin-img" src="" alt="Crypto Icon" onerror="handleImageError(this)">
        <div id="coinFallback">BTC</div>
        <div class="score-popup" id="scorePopup">+10</div>
        <div class="game-over-text" id="gameOverIndicator">GAME OVER</div>
      </div>
      <div class="options-grid" id="optionsGrid"></div>
      <div class="jokers-area">
        <button class="joker-btn" id="btnJoker50" onclick="useJoker('5050')"><span>¬Ω</span> 50/50</button>
        <button class="joker-btn" id="btnJokerDouble" onclick="useJoker('double')"><span>‚Ü∫</span> Double Guess</button>
      </div>
    </div>

    <!-- QUESTS -->
    <div id="screen-quests" class="screen">
      <h2 style="margin-top: 0;">Joker Activation</h2>
      <div class="quest-card">
        <div style="font-weight: bold; margin-bottom: 8px; font-size: 0.9rem;">Required Follows</div>
        <div class="quest-profiles" id="quest-profiles-container"></div>
        <div style="font-size: 0.75rem; margin: 10px 0; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px;">Includes <b>Daily Winner</b> (UTC+3)</div>
        <button class="btn-main" id="btnVerifyQuest" style="font-size: 0.9rem; padding: 10px;" onclick="verifyQuest()">Verify Follows & Unlock</button>
        <div id="questTimer" style="text-align: center; font-size: 0.8rem; color: var(--success); margin-top: 5px; display: none; font-weight: bold;">‚úÖ Active!</div>
      </div>
      <h3>Achievements</h3>
      <div class="badge-grid" id="badgesContainer"></div>
    </div>

    <!-- LEADERBOARD -->
    <div id="screen-leaderboard" class="screen">
      <div class="lb-filters">
        <button id="lbBtnDaily" class="lb-btn active" onclick="renderLeaderboard('daily')">Daily</button>
        <button id="lbBtnAll" class="lb-btn" onclick="renderLeaderboard('alltime')">All Time</button>
      </div>
      <div style="background: rgba(99, 102, 241, 0.1); padding: 10px; border-radius: 8px; font-size: 0.8rem; margin-bottom: 15px; border: 1px solid rgba(99, 102, 241, 0.3);">
        üèÜ The #1 Daily player (UTC+3) is featured in the Quest list for 24h!
      </div>
      <div style="text-align: center; font-size: 0.7rem; color: #64748b; margin-bottom: 10px;">* Global ranking requires database. Current list is simulation.</div>
      <div id="lb-list"></div>
    </div>
  </div>

  <!-- NAV BAR -->
  <nav class="nav-bar">
    <button class="nav-item active" onclick="navTo('home')"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Play</button>
    <button class="nav-item" onclick="navTo('quests')"><svg viewBox="0 0 24 24"><path d="M12 2L1 21h22M12 6l7.53 13H4.47"/></svg>Quests</button>
    <button class="nav-item" onclick="navTo('leaderboard')"><svg viewBox="0 0 24 24"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg>Rank</button>
  </nav>
</div>

<!-- RESULT MODAL -->
<div class="overlay hidden" id="modalOverlay"></div>
<div class="result-modal hidden" id="modalBox">
  <div class="res-title">GAME OVER</div>
  <div class="res-label">FINAL SCORE</div>
  <div class="res-score" id="resScoreVal">0</div>
  <div class="res-best">üèÜ Personal Best: <span id="resBestVal">0</span></div>
  <button class="btn-main" style="margin-top: 25px; width: 100%;" onclick="restartGame()">üîÑ Play Again</button>
  <button class="btn-secondary" onclick="closeModal()">Home</button>
</div>

<script>
// --- CONFIG ---
const CONTRACT_ADDRESS = "0x5827273795C64E328D8F27B5e8DDB2E4187b1dA6"; 
const CONFIG = { totalTime: 7000, baseChainId: '8453' };
const MINIMAL_ABI = ["function mint(uint256 id, uint256 amount) public"];
const BADGE_ID_MAP = {'daily_1': 1, 'alltime_10': 2, 'games_5': 3, 'games_10': 4, 'games_20': 5, 'games_50': 6, 'score_100': 7, 'score_200': 8, 'score_250': 9, 'joker_10': 10};
const BADGE_DEFS = [
  { id: 'daily_1', type: 'rank_daily', target: 1, icon: 'ü•á', title: 'Daily King', desc: 'Rank #1 Daily' },
  { id: 'alltime_10', type: 'rank_all', target: 10, icon: 'üåü', title: 'Top 10 Elite', desc: 'Top 10 All Time' },
  { id: 'games_5', type: 'games', target: 5, icon: 'üéÆ', title: 'Rookie', desc: 'Play 5 games' },
  { id: 'games_10', type: 'games', target: 10, icon: 'üé≤', title: 'Regular', desc: 'Play 10 games' },
  { id: 'games_20', type: 'games', target: 20, icon: 'üïπÔ∏è', title: 'Gamer', desc: 'Play 20 games' },
  { id: 'games_50', type: 'games', target: 50, icon: 'üî•', title: 'Addict', desc: 'Play 50 games' },
  { id: 'score_100', type: 'highScore', target: 100, icon: 'ü•â', title: 'Bronze', desc: 'Score 100 pts' },
  { id: 'score_200', type: 'highScore', target: 200, icon: 'ü•à', title: 'Silver', desc: 'Score 200 pts' },
  { id: 'score_250', type: 'highScore', target: 250, icon: 'ü•á', title: 'Gold', desc: 'Score 250 pts' },
  { id: 'joker_10', type: 'jokers', target: 10, icon: 'üÉè', title: 'Trickster', desc: 'Use 10 jokers' }
];

const COIN_DB = [
  {id: "bitcoin", symbol: "btc", name: "Bitcoin", img: "https://assets.coingecko.com/coins/images/1/large/bitcoin.png"},
  {id: "ethereum", symbol: "eth", name: "Ethereum", img: "https://assets.coingecko.com/coins/images/279/large/ethereum.png"},
  {id: "binancecoin", symbol: "bnb", name: "BNB", img: "https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png"},
  {id: "solana", symbol: "sol", name: "Solana", img: "https://assets.coingecko.com/coins/images/4128/large/solana.png"},
  {id: "ripple", symbol: "xrp", name: "XRP", img: "https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png"},
  {id: "dogecoin", symbol: "doge", name: "Dogecoin", img: "https://assets.coingecko.com/coins/images/5/large/dogecoin.png"},
  {id: "cardano", symbol: "ada", name: "Cardano", img: "https://assets.coingecko.com/coins/images/975/large/cardano.png"},
  {id: "avalanche-2", symbol: "avax", name: "Avalanche", img: "https://assets.coingecko.com/coins/images/12559/large/Avalanche_Circle_RedWhite_Trans.png"},
  {id: "tron", symbol: "trx", name: "TRON", img: "https://assets.coingecko.com/coins/images/1094/large/tron-logo.png"},
  {id: "polkadot", symbol: "dot", name: "Polkadot", img: "https://assets.coingecko.com/coins/images/12171/large/polkadot.png"},
  {id: "chainlink", symbol: "link", name: "Chainlink", img: "https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png"},
  {id: "matic-network", symbol: "matic", name: "Polygon", img: "https://assets.coingecko.com/coins/images/4713/large/matic-token-icon.png"},
  {id: "shiba-inu", symbol: "shib", name: "Shiba Inu", img: "https://assets.coingecko.com/coins/images/11939/large/shiba.png"},
  {id: "litecoin", symbol: "ltc", name: "Litecoin", img: "https://assets.coingecko.com/coins/images/2/large/litecoin.png"},
  {id: "uniswap", symbol: "uni", name: "Uniswap", img: "https://assets.coingecko.com/coins/images/12504/large/uniswap-uni.png"},
  {id: "stellar", symbol: "xlm", name: "Stellar", img: "https://assets.coingecko.com/coins/images/100/large/Stellar_symbol_black_RGB.png"},
  {id: "monero", symbol: "xmr", name: "Monero", img: "https://assets.coingecko.com/coins/images/69/large/monero_logo.png"},
  {id: "cosmos", symbol: "atom", name: "Cosmos Hub", img: "https://assets.coingecko.com/coins/images/1481/large/cosmos_hub.png"},
  {id: "okb", symbol: "okb", name: "OKB", img: "https://assets.coingecko.com/coins/images/4463/large/WeChat_Image_20220118095618.png"},
  {id: "aptos", symbol: "apt", name: "Aptos", img: "https://assets.coingecko.com/coins/images/26455/large/aptos_round.png"},
  {id: "near", symbol: "near", name: "NEAR Protocol", img: "https://assets.coingecko.com/coins/images/10365/large/near.png"},
  {id: "filecoin", symbol: "fil", name: "Filecoin", img: "https://assets.coingecko.com/coins/images/12817/large/filecoin.png"},
  {id: "arbitrum", symbol: "arb", name: "Arbitrum", img: "https://assets.coingecko.com/coins/images/16547/large/photo_2023-03-29_21.47.00.jpeg"},
  {id: "pepe", symbol: "pepe", name: "Pepe", img: "https://assets.coingecko.com/coins/images/29850/large/pepe-token.jpeg"},
  {id: "maker", symbol: "mkr", name: "Maker", img: "https://assets.coingecko.com/coins/images/1364/large/Mark_Maker.png"},
  {id: "optimism", symbol: "op", name: "Optimism", img: "https://assets.coingecko.com/coins/images/25244/large/Optimism.png"},
  {id: "aave", symbol: "aave", name: "Aave", img: "https://assets.coingecko.com/coins/images/12645/large/AAVE.png"},
  {id: "graph", symbol: "grt", name: "The Graph", img: "https://assets.coingecko.com/coins/images/13397/large/Graph_Token.png"},
  {id: "algorand", symbol: "algo", name: "Algorand", img: "https://assets.coingecko.com/coins/images/4380/large/download.png"},
  {id: "render-token", symbol: "rndr", name: "Render", img: "https://assets.coingecko.com/coins/images/11636/large/rndr.png"},
  {id: "injective-protocol", symbol: "inj", name: "Injective", img: "https://assets.coingecko.com/coins/images/12882/large/Secondary_Symbol.png"},
  {id: "immutable-x", symbol: "imx", name: "Immutable", img: "https://assets.coingecko.com/coins/images/17233/large/imx.png"},
  {id: "fantom", symbol: "ftm", name: "Fantom", img: "https://assets.coingecko.com/coins/images/4001/large/Fantom_round.png"},
  {id: "vechain", symbol: "vet", name: "VeChain", img: "https://assets.coingecko.com/coins/images/1167/large/VeChain-Logo-768x725.png"},
  {id: "theta-token", symbol: "theta", name: "Theta Network", img: "https://assets.coingecko.com/coins/images/2538/large/theta-token-logo.png"},
  {id: "the-sandbox", symbol: "sand", name: "The Sandbox", img: "https://assets.coingecko.com/coins/images/12129/large/sandbox_logo.jpg"},
  {id: "decentraland", symbol: "mana", name: "Decentraland", img: "https://assets.coingecko.com/coins/images/878/large/decentraland-mana.png"},
  {id: "axie-infinity", symbol: "axs", name: "Axie Infinity", img: "https://assets.coingecko.com/coins/images/13029/large/axie_infinity_logo.png"},
  {id: "eos", symbol: "eos", name: "EOS", img: "https://assets.coingecko.com/coins/images/738/large/eos-eos-logo.png"},
  {id: "tezos", symbol: "xtz", name: "Tezos", img: "https://assets.coingecko.com/coins/images/976/large/Tezos-logo.png"},
  {id: "elrond-erd-2", symbol: "egld", name: "MultiversX", img: "https://assets.coingecko.com/coins/images/12335/large/egld-token-logo.png"},
  {id: "neo", symbol: "neo", name: "NEO", img: "https://assets.coingecko.com/coins/images/480/large/NEO_512_512.png"},
  {id: "flow", symbol: "flow", name: "Flow", img: "https://assets.coingecko.com/coins/images/13446/large/5f6294c0c7a8cda55cb1c936_Flow_Wordmark.png"},
  {id: "klay-token", symbol: "klay", name: "Klaytn", img: "https://assets.coingecko.com/coins/images/9672/large/klaytn.png"},
  {id: "kucoin-shares", symbol: "kcs", name: "KuCoin", img: "https://assets.coingecko.com/coins/images/1047/large/sa9QgOxP.png"},
  {id: "synthetix-network-token", symbol: "snx", name: "Synthetix", img: "https://assets.coingecko.com/coins/images/3406/large/SNX.png"},
  {id: "conflux-token", symbol: "cfx", name: "Conflux", img: "https://assets.coincap.io/assets/icons/cfx@2x.png"},
  {id: "mina-protocol", symbol: "mina", name: "Mina Protocol", img: "https://assets.coingecko.com/coins/images/15628/large/mina.png"},
  {id: "chiliz", symbol: "chz", name: "Chiliz", img: "https://assets.coingecko.com/coins/images/8834/large/Chiliz.png"},
  {id: "gala", symbol: "gala", name: "GALA", img: "https://assets.coingecko.com/coins/images/12493/large/GALA-COINGECKO.png"},
  {id: "huobi-token", symbol: "ht", name: "Huobi", img: "https://assets.coingecko.com/coins/images/2822/large/huobi-token-logo.png"},
  {id: "bittorrent", symbol: "btt", name: "BitTorrent", img: "https://assets.coingecko.com/coins/images/22457/large/btt_logo.png"},
  {id: "dydx", symbol: "dydx", name: "dYdX", img: "https://assets.coingecko.com/coins/images/17500/large/hjnIm9bV.jpg"},
  {id: "pancakeswap-token", symbol: "cake", name: "PancakeSwap", img: "https://assets.coingecko.com/coins/images/12632/large/pancakeswap-cake-logo_%281%29.png"},
  {id: "zcash", symbol: "zec", name: "Zcash", img: "https://assets.coingecko.com/coins/images/486/large/circle-zcash-color.png"},
  {id: "iota", symbol: "miota", name: "IOTA", img: "https://assets.coingecko.com/coins/images/692/large/IOTA_Swirl.png"},
  {id: "dash", symbol: "dash", name: "Dash", img: "https://assets.coingecko.com/coins/images/19/large/dash-logo.png"},
  {id: "arweave", symbol: "ar", name: "Arweave", img: "https://assets.coingecko.com/coins/images/4343/large/o5OwxTC.png"},
  {id: "curve-dao-token", symbol: "crv", name: "Curve DAO", img: "https://assets.coingecko.com/coins/images/12124/large/Curve.png"},
  {id: "zilliqa", symbol: "zil", name: "Zilliqa", img: "https://assets.coingecko.com/coins/images/2687/large/Zilliqa-logo.png"},
  {id: "1inch", symbol: "1inch", name: "1inch", img: "https://assets.coingecko.com/coins/images/13469/large/1inch-token.png"},
  {id: "basic-attention-token", symbol: "bat", name: "Basic Attention Token", img: "https://assets.coingecko.com/coins/images/677/large/basic-attention-token.png"},
  {id: "loopring", symbol: "lrc", name: "Loopring", img: "https://assets.coingecko.com/coins/images/913/large/LRC.png"},
  {id: "enjincoin", symbol: "enj", name: "Enjin Coin", img: "https://assets.coingecko.com/coins/images/1102/large/enjin-coin-logo.png"},
  {id: "celo", symbol: "celo", name: "Celo", img: "https://assets.coingecko.com/coins/images/11090/large/icon-celo-CELO-color-500.png"},
  {id: "mask-network", symbol: "mask", name: "Mask Network", img: "https://assets.coincap.io/assets/icons/mask@2x.png"},
  {id: "audius", symbol: "audio", name: "Audius", img: "https://assets.coingecko.com/coins/images/12913/large/Audius_Coin.png"},
  {id: "api3", symbol: "api3", name: "API3", img: "https://assets.coingecko.com/coins/images/13256/large/api3.png"},
  {id: "balancer", symbol: "bal", name: "Balancer", img: "https://assets.coingecko.com/coins/images/11683/large/Balancer.png"},
  {id: "moonriver", symbol: "movr", name: "Moonriver", img: "https://assets.coingecko.com/coins/images/17984/large/movr.jpeg"},
  {id: "band-protocol", symbol: "band", name: "Band Protocol", img: "https://assets.coingecko.com/coins/images/9545/large/band-protocol.png"},
  {id: "flux-zelcash", symbol: "flux", name: "Flux", img: "https://assets.coingecko.com/coins/images/5163/large/Flux_icon.png"},
  {id: "icon", symbol: "icx", name: "ICON", img: "https://assets.coingecko.com/coins/images/1060/large/icon-icx-logo.png"},
  {id: "siacoin", symbol: "sc", name: "Siacoin", img: "https://assets.coingecko.com/coins/images/289/large/siacoin.png"},
  {id: "digibyte", symbol: "dgb", name: "DigiByte", img: "https://assets.coingecko.com/coins/images/63/large/digibyte.png"},
  {id: "hive", symbol: "hive", name: "Hive", img: "https://assets.coingecko.com/coins/images/10840/large/hive_logo_icon_transparent.png"},
  {id: "wax", symbol: "waxp", name: "WAX", img: "https://assets.coingecko.com/coins/images/1372/large/WAX_Coin_Bright_RGB.png"},
  {id: "biconomy", symbol: "bico", name: "Biconomy", img: "https://assets.coingecko.com/coins/images/21061/large/biconomy_logo.jpg"},
  {id: "synapse-2", symbol: "syn", name: "Synapse", img: "https://assets.coingecko.com/coins/images/18029/large/synapse.png"},
  {id: "stargate-finance", symbol: "stg", name: "Stargate Finance", img: "https://assets.coincap.io/assets/icons/stg@2x.png"},
  {id: "threshold-network-token", symbol: "t", name: "Threshold", img: "https://assets.coingecko.com/coins/images/23246/large/threshold_logo.jpg"},
  {id: "keep-network", symbol: "keep", name: "Keep Network", img: "https://assets.coingecko.com/coins/images/11096/large/keep-logo.png"},
  {id: "nkn", symbol: "nkn", name: "NKN", img: "https://assets.coingecko.com/coins/images/3375/large/nkn.png"},
  {id: "civic", symbol: "cvc", name: "Civic", img: "https://assets.coingecko.com/coins/images/788/large/civic.png"},
  {id: "power-ledger", symbol: "powr", name: "Powerledger", img: "https://assets.coingecko.com/coins/images/1057/large/Powerledger_Logo.png"},
  {id: "stormx", symbol: "stmx", name: "StormX", img: "https://assets.coingecko.com/coins/images/208/large/stormx.jpg"},
  {id: "status", symbol: "snt", name: "Status", img: "https://assets.coingecko.com/coins/images/779/large/status.png"},
  {id: "numeraire", symbol: "nmr", name: "Numeraire", img: "https://assets.coingecko.com/coins/images/752/large/numeraire.png"},
  {id: "orchid-protocol", symbol: "oxt", name: "Orchid", img: "https://assets.coingecko.com/coins/images/10168/large/orchid.png"},
  {id: "prometeus", symbol: "prom", name: "Prom", img: "https://assets.coingecko.com/coins/images/8470/large/prom.png"},
  {id: "aelf", symbol: "elf", name: "aelf", img: "https://assets.coingecko.com/coins/images/1371/large/aelf-logo.png"},
  {id: "request-network", symbol: "req", name: "Request", img: "https://assets.coingecko.com/coins/images/1070/large/req.png"},
  {id: "ark", symbol: "ark", name: "Ark", img: "https://assets.coincap.io/assets/icons/ark@2x.png"},
  {id: "strax", symbol: "strax", name: "Stratis", img: "https://assets.coingecko.com/coins/images/13098/large/strax.png"},
  {id: "verge", symbol: "xvg", name: "Verge", img: "https://assets.coingecko.com/coins/images/61/large/verge.png"},
  {id: "metal", symbol: "mtl", name: "Metal", img: "https://assets.coingecko.com/coins/images/765/large/metal.png"},
  {id: "ardor", symbol: "ardr", name: "Ardor", img: "https://assets.coingecko.com/coins/images/557/large/ardor.png"},
  {id: "loom-network", symbol: "loom", name: "Loom Network", img: "https://assets.coingecko.com/coins/images/3103/large/Loom.png"},
  {id: "rif-token", symbol: "rif", name: "RSK Infrastructure Framework", img: "https://assets.coingecko.com/coins/images/7454/large/RIF.png"},
  {id: "tomochain", symbol: "tomo", name: "TomoChain", img: "https://assets.coingecko.com/coins/images/2819/large/logo-tomochain-200.png"},
  {id: "quarkchain", symbol: "qkc", name: "QuarkChain", img: "https://assets.coingecko.com/coins/images/4340/large/QurakChain.png"},
  {id: "thunder-token", symbol: "tt", name: "ThunderCore", img: "https://assets.coingecko.com/coins/images/8488/large/thundercore.png"},
  {id: "iris-network", symbol: "iris", name: "IRISnet", img: "https://assets.coincap.io/assets/icons/iris@2x.png"},
  {id: "marlin", symbol: "pond", name: "Marlin", img: "https://assets.coincap.io/assets/icons/pond@2x.png"},
  {id: "akropolis", symbol: "akro", name: "Akropolis", img: "https://assets.coingecko.com/coins/images/7473/large/akropolis.png"},
  {id: "dia-data", symbol: "dia", name: "DIA", img: "https://assets.coingecko.com/coins/images/11955/large/dia.png"},
  {id: "dock", symbol: "dock", name: "Dock", img: "https://assets.coingecko.com/coins/images/3719/large/dock-new.png"},
  {id: "pundix-new", symbol: "pundix", name: "Pundi X", img: "https://assets.coingecko.com/coins/images/14589/large/pundix.png"},
  {id: "wanchain", symbol: "wan", name: "Wanchain", img: "https://assets.coingecko.com/coins/images/3358/large/wanchain-logo.png"},
  {id: "cortex", symbol: "ctxc", name: "Cortex", img: "https://assets.coingecko.com/coins/images/3757/large/Cortex.png"},
  {id: "lto-network", symbol: "lto", name: "LTO Network", img: "https://assets.coingecko.com/coins/images/7533/large/lto-logo.png"},
  {id: "fio-protocol", symbol: "fio", name: "FIO Protocol", img: "https://assets.coingecko.com/coins/images/11822/large/FIO_Token_Logo.png"},
  {id: "aergo", symbol: "aergo", name: "Aergo", img: "https://assets.coingecko.com/coins/images/4489/large/aergo.png"},
  {id: "steem", symbol: "steem", name: "Steem", img: "https://assets.coingecko.com/coins/images/303/large/steem.png"},
  {id: "syscoin", symbol: "sys", name: "Syscoin", img: "https://assets.coincap.io/assets/icons/sys@2x.png"},
  {id: "komodo", symbol: "kmd", name: "Komodo", img: "https://assets.coingecko.com/coins/images/611/large/KMD_Mark_Color.png"},
  {id: "bluzelle", symbol: "blz", name: "Bluzelle", img: "https://assets.coincap.io/assets/icons/blz@2x.png"},
  {id: "data", symbol: "dta", name: "DATA", img: "https://assets.coingecko.com/coins/images/2627/large/data.png"},
  {id: "propy", symbol: "pro", name: "Propy", img: "https://assets.coingecko.com/coins/images/735/large/propy.png"},
  {id: "covalent", symbol: "cqt", name: "Covalent", img: "https://assets.coingecko.com/coins/images/15473/large/covalent.png"},
  {id: "ampleforth", symbol: "ampl", name: "Ampleforth", img: "https://assets.coingecko.com/coins/images/8776/large/Ampleforth_rebrand_logo.png"},
  {id: "verasity", symbol: "vra", name: "Verasity", img: "https://assets.coincap.io/assets/icons/vra@2x.png"},
  {id: "alien-worlds", symbol: "tlm", name: "Alien Worlds", img: "https://assets.coingecko.com/coins/images/14710/large/tlm.png"},
  {id: "aurora-near", symbol: "aurora", name: "Aurora", img: "https://assets.coingecko.com/coins/images/20593/large/aurora.jpeg"},
  {id: "pivx", symbol: "pivx", name: "PIVX", img: "https://assets.coincap.io/assets/icons/pivx@2x.png"},
  {id: "ad-shares", symbol: "ads", name: "Adshares", img: "https://assets.coingecko.com/coins/images/4962/large/ADS_Logotype_Blue.png"},
  {id: "polkastarter", symbol: "pols", name: "Polkastarter", img: "https://assets.coingecko.com/coins/images/12648/large/polkastarter.png"},
  {id: "energy-web-token", symbol: "ewt", name: "Energy Web", img: "https://assets.coingecko.com/coins/images/10636/large/Energy_Web.png"},
  {id: "telos", symbol: "tlos", name: "Telos", img: "https://assets.coingecko.com/coins/images/7588/large/tlos.png"},
  {id: "constellation-labs", symbol: "dag", name: "Constellation", img: "https://assets.coingecko.com/coins/images/4645/large/DAG.png"},
  {id: "orbs", symbol: "orbs", name: "Orbs", img: "https://assets.coingecko.com/coins/images/8133/large/Orbs.png"},
  {id: "bancor", symbol: "bnt", name: "Bancor Network", img: "https://assets.coingecko.com/coins/images/736/large/bancor.png"},
  {id: "celsius-degree-token", symbol: "cel", name: "Celsius", img: "https://assets.coingecko.com/coins/images/3263/large/CEL.png"},
  {id: "quarkchain", symbol: "qkc", name: "QuarkChain", img: "https://assets.coingecko.com/coins/images/4340/large/QurakChain.png"},
  {id: "singularitydao", symbol: "sdao", name: "SingularityDAO", img: "https://assets.coingecko.com/coins/images/15452/large/sdao.png"},
  {id: "rally-2", symbol: "rly", name: "Rally", img: "https://assets.coingecko.com/coins/images/12843/large/rly.png"},
  {id: "persistence", symbol: "xprt", name: "Persistence", img: "https://assets.coingecko.com/coins/images/14467/large/xprt.png"},
  {id: "verus-coin", symbol: "vrsc", name: "Verus Coin", img: "https://assets.coingecko.com/coins/images/4447/large/verus.png"},
  {id: "kleros", symbol: "pnk", name: "Kleros", img: "https://assets.coingecko.com/coins/images/4183/large/kleros_symbol.png"},
  {id: "quarkchain", symbol: "qkc", name: "QuarkChain", img: "https://assets.coingecko.com/coins/images/4340/large/QurakChain.png"},
  {id: "utrust", symbol: "utk", name: "xMoney", img: "https://assets.coingecko.com/coins/images/1435/large/utk.png"},
  {id: "adventure-gold", symbol: "agld", name: "Adventure Gold", img: "https://assets.coingecko.com/coins/images/18165/large/agld.png"},
  {id: "gods-unchained", symbol: "gods", name: "Gods Unchained", img: "https://assets.coingecko.com/coins/images/19441/large/gods.png"},
  {id: "radworks", symbol: "rad", name: "Radworks", img: "https://assets.coingecko.com/coins/images/15456/large/rad.png"},
  {id: "badger-dao", symbol: "badger", name: "Badger DAO", img: "https://assets.coingecko.com/coins/images/13292/large/badger.png"},
  {id: "rif-token", symbol: "rif", name: "RIF", img: "https://assets.coingecko.com/coins/images/7454/large/RIF.png"},
  {id: "ergo", symbol: "erg", name: "Ergo", img: "https://assets.coingecko.com/coins/images/2484/large/ergo-logo.png"},
  {id: "lisk", symbol: "lsk", name: "Lisk", img: "https://assets.coingecko.com/coins/images/385/large/Lisk_Symbol_Blue.png"},
  {id: "nano", symbol: "xno", name: "Nano", img: "https://assets.coingecko.com/coins/images/756/large/nano.png"},
  {id: "banano", symbol: "ban", name: "Banano", img: "https://assets.coingecko.com/coins/images/4706/large/banano.png"},
  {id: "firo", symbol: "firo", name: "Firo", img: "https://assets.coingecko.com/coins/images/623/large/Firo.png"},
  {id: "groestlcoin", symbol: "grs", name: "Groestlcoin", img: "https://assets.coingecko.com/coins/images/563/large/groestlcoin.png"},
  {id: "beam-2", symbol: "beam", name: "Beam", img: "https://assets.coingecko.com/coins/images/32329/large/beam.png"},
  {id: "grin", symbol: "grin", name: "Grin", img: "https://assets.coingecko.com/coins/images/7552/large/grin.png"},
  {id: "monacoin", symbol: "mona", name: "MonaCoin", img: "https://assets.coincap.io/assets/icons/mona@2x.png"},
  {id: "reddcoin", symbol: "rdd", name: "ReddCoin", img: "https://assets.coingecko.com/coins/images/219/large/reddcoin.png"},
  {id: "vertcoin", symbol: "vtc", name: "Vertcoin", img: "https://assets.coincap.io/assets/icons/vtc@2x.png"},
  {id: "namecoin", symbol: "nmc", name: "Namecoin", img: "https://assets.coingecko.com/coins/images/315/large/namecoin.png"},
  {id: "peercoin", symbol: "ppc", name: "Peercoin", img: "https://assets.coingecko.com/coins/images/409/large/peercoin.png"},
  {id: "primecoin", symbol: "xpm", name: "Primecoin", img: "https://assets.coingecko.com/coins/images/526/large/primecoin.png"},
  {id: "feathercoin", symbol: "ftc", name: "Feathercoin", img: "https://assets.coingecko.com/coins/images/373/large/feathercoin.png"}
];

function handleImageError(img) {
  if (!img || !currentCoin) return;
  if (img.src.includes('assets.coincap.io')) {
    img.style.display = 'none';
    document.getElementById('coinFallback').style.display = 'flex';
    document.getElementById('coinFallback').innerText = currentCoin.symbol.toUpperCase();
    return;
  }
  img.src = `https://assets.coincap.io/assets/icons/${currentCoin.symbol.toLowerCase()}@2x.png`;
}

let state = {
  score: 0, totalPoints: 0, totalGames: 0, jokersUsed: 0, bestScore: 0,
  jokersUnlockedUntil: 0, claimedBadges: [], 
  lastWeekWinners: ["@crypto_guru", "@nft_whale"],
  history: [{user: "@ayktbyr", score: 150, date: Date.now()-10000}]
};
let currentCoin, currentOptions, gameTimer, timerStart;
let usedCoinIds = new Set();
let activeJokers = { fifty: false, double: false };
let doubleChanceUsed = false;
let sessionJokers = { fifty: false, double: false };
function isJokerUsed(type) { return sessionJokers[type]; }
let isSessionActive = false; 

if(window.initGame) window.initGame();

function saveState() { localStorage.setItem('iconMasterV22', JSON.stringify(state)); updateUI(); checkBadges(); }
function loadState() {
  const saved = localStorage.getItem('iconMasterV22');
  if (saved) state = {...state, ...JSON.parse(saved)};
  if(!state.claimedBadges) state.claimedBadges = [];
  if(!state.lastWeekWinners) state.lastWeekWinners = ["@crypto_guru", "@nft_whale"];
}

function navTo(screenName) {
  document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById(`screen-${screenName}`).classList.add('active');
  if(screenName === 'leaderboard') renderLeaderboard('daily');
  if(screenName === 'quests') { updateQuestLeaders(); renderBadges(); }
}

// START GAME (Check Wallet & Network)
async function startGameFlow() {
  if (isSessionActive) {
      launchGame();
      return;
  }

  const btn = document.getElementById('btnStartGame');
  btn.disabled = true; btn.innerHTML = '<div class="loader"></div>';
  
  try {
    let provider;
    if (window.sdk && window.sdk.wallet && window.sdk.wallet.ethProvider) {
      provider = new ethers.BrowserProvider(window.sdk.wallet.ethProvider, "any");
    } else if (window.ethereum) {
      provider = new ethers.BrowserProvider(window.ethereum, "any");
    } else {
      throw new Error("Wallet not found.");
    }
    
    // Auto-switch network
    try { await provider.send("wallet_switchEthereumChain", [{ chainId: "0x2105" }]); } catch(e){}

    await provider.send("eth_requestAccounts", []);
    const signer = await provider.getSigner();
    
    // REAL TX to verify/start (0 ETH) - Added Gas Limit to fix Estimation Error
    const tx = { 
      to: await signer.getAddress(), 
      value: 0,
      gasLimit: 25000 // FIX: Force gas limit to skip estimation
    }; 
    await signer.sendTransaction(tx);
    
    isSessionActive = true; 
    launchGame();
  } catch (err) {
    let msg = "Transaction cancelled.";
    if (err.code === "INSUFFICIENT_FUNDS") msg = "Insufficient funds (ETH required on Base).";
    else if (err.code === "ACTION_REJECTED") msg = "Transaction rejected by user.";
    
    alert(msg);
  } finally {
    btn.disabled = false; btn.innerText = "Start Game";
  }
}

function launchGame() {
  state.score = 0; usedCoinIds.clear();
  activeJokers = { fifty: false, double: false }; sessionJokers = { fifty: false, double: false };
  doubleChanceUsed = false;
  navTo('game'); nextLevel();
}

function restartGame() {
    closeModal();
    // Direct launch without TX if session is active
    launchGame(); 
}

function nextLevel() {
  if (usedCoinIds.size >= COIN_DB.length) { endGame("All Coins Completed!"); return; }
  doubleChanceUsed = false;
  if(activeJokers.double) {
     activeJokers.double = false; 
     document.getElementById('btnJokerDouble').classList.remove('active');
     document.getElementById('btnJokerDouble').classList.add('used');
  }
  
  document.getElementById('scorePopup').classList.remove('pop');
  document.getElementById('coinImage').style.display = 'block';
  document.getElementById('coinFallback').style.display = 'none';
  document.getElementById('gameOverIndicator').style.display = 'none';
  
  let pool = COIN_DB.filter(c => !usedCoinIds.has(c.id));
  if(pool.length === 0) { pool = COIN_DB; usedCoinIds.clear(); }
  currentCoin = pool[Math.floor(Math.random() * pool.length)];
  usedCoinIds.add(currentCoin.id);
  
  let wrongs = COIN_DB.filter(c => c.id !== currentCoin.id).sort(() => 0.5 - Math.random()).slice(0, 3);
  currentOptions = [currentCoin, ...wrongs].sort(() => 0.5 - Math.random());
  
  renderGameScreen();
  startTimer(usedCoinIds.size === 1 ? 10000 : 7000);
}

function renderGameScreen() {
  document.getElementById('coinImage').src = currentCoin.img;
  document.getElementById('gameScore').innerText = state.score;
  const grid = document.getElementById('optionsGrid'); grid.innerHTML = '';
  currentOptions.forEach(opt => {
    const btn = document.createElement('button'); btn.className = 'option-btn';
    btn.innerText = opt.name; btn.disabled = false;
    btn.onclick = (e) => handleAnswer(opt.id, e.target);
    grid.appendChild(btn);
  });
  
  const jokersUnlocked = Date.now() < state.jokersUnlockedUntil;
  document.getElementById('btnJoker50').className = `joker-btn ${jokersUnlocked && !sessionJokers.fifty ? 'active' : 'used'}`;
  document.getElementById('btnJokerDouble').className = `joker-btn ${jokersUnlocked && !sessionJokers.double ? '' : 'used'}`;
  if(activeJokers.double) document.getElementById('btnJokerDouble').classList.add('active');
}

function startTimer(ms) {
  clearInterval(gameTimer); timerStart = Date.now();
  gameTimer = setInterval(() => {
    const elapsed = Date.now() - timerStart;
    document.getElementById('gameTime').innerText = (Math.max(0, ms - elapsed)/1000).toFixed(1) + 's';
    document.getElementById('timerFill').style.width = ((ms-elapsed)/ms)*100 + '%';
    if(elapsed >= ms) { clearInterval(gameTimer); handleTimeout(); }
  }, 50);
}

function handleAnswer(id, btn) {
  if(btn.disabled) return;
  const allBtns = document.querySelectorAll('.option-btn');
  allBtns.forEach(b => b.disabled = true); 

  if(id === currentCoin.id) {
    clearInterval(gameTimer);
    const pts = Math.max(1, Math.ceil(10 * (1 - (Date.now()-timerStart)/(usedCoinIds.size===1?10000:7000))));
    state.score += pts; 
    btn.classList.add('correct');
    btn.classList.remove('wrong');
    document.getElementById('scorePopup').innerText = `+${pts}`;
    document.getElementById('scorePopup').classList.add('pop');
    confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 }, colors: ['#22c55e', '#fbbf24'] });
    setTimeout(nextLevel, 1000);
  } else {
    btn.classList.add('wrong'); btn.disabled = true;
    if(activeJokers.double && !doubleChanceUsed) { 
        doubleChanceUsed = true; 
        allBtns.forEach(b => { if(b !== btn && !b.classList.contains('disabled-by-joker')) b.disabled = false; });
        return; 
    }
    clearInterval(gameTimer);
    Array.from(document.querySelectorAll('.option-btn')).find(b => b.innerText === currentCoin.name).classList.add('correct');
    document.getElementById('gameOverIndicator').style.display = 'block';
    setTimeout(() => endGame("Wrong Answer!"), 1500);
  }
}
function handleTimeout() {
    const allBtns = document.querySelectorAll('.option-btn');
    allBtns.forEach(b => {
      b.disabled = true;
      if (b.innerText === currentCoin.name) b.classList.add('correct');
    });
    document.getElementById('gameOverIndicator').style.display = 'block';
    setTimeout(() => endGame("Time's Up!"), 1500);
}

function endGame(msg) {
  state.totalGames++; state.totalPoints += state.score;
  if(state.score > state.bestScore) state.bestScore = state.score;
  state.history.push({user:"You", score:state.score, date:Date.now()});
  saveState();
  
  document.getElementById('resScoreVal').innerText = state.score;
  document.getElementById('resBestVal').innerText = state.bestScore;
  
  document.getElementById('modalOverlay').classList.remove('hidden');
  document.getElementById('modalBox').classList.remove('hidden');
}

function useJoker(type) {
  if(Date.now() > state.jokersUnlockedUntil) { alert("Complete Quests first!"); navTo('quests'); return; }
  if(sessionJokers[type]) return;
  state.jokersUsed++;
  if(type === '5050') {
    activeJokers.fifty = true; sessionJokers.fifty = true;
    document.getElementById('btnJoker50').classList.add('used');
    const wrongs = Array.from(document.querySelectorAll('.option-btn')).filter(b => b.innerText !== currentCoin.name);
    wrongs.sort(() => 0.5 - Math.random()).slice(0, 2).forEach(b => { b.disabled = true; b.style.opacity = 0.2; b.classList.add('disabled-by-joker'); });
  } else {
    activeJokers.double = true; sessionJokers.double = true;
    document.getElementById('btnJokerDouble').classList.add('active');
  }
  saveState();
}

function verifyQuest() {
    state.jokersUnlockedUntil = Date.now() + 86400000; saveState();
    updateJokerStatus(); confetti();
}
function updateJokerStatus() {
    const active = Date.now() < state.jokersUnlockedUntil;
    document.getElementById('questTimer').style.display = active ? 'block' : 'none';
    document.getElementById('btnVerifyQuest').style.display = active ? 'none' : 'block';
}
function updateQuestLeaders() {
    const container = document.getElementById('quest-profiles-container');
    if(!container) return;
    container.innerHTML = `
    <div onclick="if(window.sdk) window.sdk.actions.openUrl('https://warpcast.com/ayktbyr')" class="profile-chip">@ayktbyr</div>
    <div onclick="if(window.sdk) window.sdk.actions.openUrl('https://warpcast.com/atmacxa')" class="profile-chip">@atmacxa</div>`;
    
    if (state.lastWeekWinners && Array.isArray(state.lastWeekWinners)) {
       state.lastWeekWinners.forEach(user => {
           const chip = document.createElement('div');
           chip.className = 'profile-chip';
           chip.innerText = user;
           container.appendChild(chip);
       });
    }
}
function updateUI() {
    document.getElementById('displayBestScore').innerText = state.bestScore;
    if(document.getElementById('homeTotalPoints')) document.getElementById('homeTotalPoints').innerText = state.totalPoints;
    if(document.getElementById('homeStreak')) document.getElementById('homeStreak').innerText = state.totalGames;
}
function closeModal() {
    document.getElementById('modalOverlay').classList.add('hidden');
    document.getElementById('modalBox').classList.add('hidden');
    navTo('home'); 
}

// ON-CHAIN MINT
async function claimBadge(id) {
  if(state.claimedBadges.includes(id)) return;
  if(CONTRACT_ADDRESS.length < 40) { alert("Contract address missing."); return; }
  
  try {
    const provider = new ethers.BrowserProvider(window.sdk?.wallet?.ethProvider || window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    const signer = await provider.getSigner();
    const contract = new ethers.Contract(CONTRACT_ADDRESS, MINIMAL_ABI, signer);
    
    // Added gasLimit to fix estimation error
    const tx = await contract.mint(BADGE_ID_MAP[id], 1, { gasLimit: 150000 });
    console.log("Mint TX:", tx.hash);
    
    state.claimedBadges.push(id);
    saveState(); 
    renderBadges();
    confetti();
  } catch (err) {
    alert("Mint failed: " + (err.reason || err.message));
  }
}

function checkBadges() { /* logic same */ }
function renderBadges() { /* logic same */ }
function renderLeaderboard(filter) { /* logic same */ }

</script>
</body>
</html>
